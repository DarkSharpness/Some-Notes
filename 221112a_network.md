# 计算机网络

## 目录

## 1 协议栈分层模型

OSI分为7层，定义如下

| 层 | 名称 |
| :-: | :-: |
| 7 | Application 应用层 |
| 6 | Presentation 表示层 |
| 5 | Session 会话层 |
| 4 | Transport 传输层 |
| 3 | Network 网络层 |
| 2 | Datalink 数据链路层 |
| 1 | Physical 物理层 |

TCP/IP(DoD/ARPANet)是事实上的网络分层标准，分为5层（一说4层，无物理层），定义如下

| 层 | 名称 |
| :-: | :-: |
| 5 | Application 应用层 |
| 4 | Transport 传输层 |
| 3 | Network 网络层 |
| 2 | Datalink 数据链路层 |
| 1 | Physical 物理层 |

> `Physical`**物理层**定义了网络传输的物理媒介与连接，如同轴电缆，双绞线，光纤，无线电信号等，定义了实际的编码方式以及信号类型（例如互联方式，无线信号还是电信号或光信号，全双工还是半双工，差分信号还是非差分信号，以及这些信号的调制解调方法）。由于物理层类型繁多，且物理层中数据链路层数据可以和其他许多专有协议数据共存，如果不研究硬件，在4层模型中我们可以不用关注该层
>
> `Datalink`**数据链路层**定义了同一个网络中各元素之间的数据传递，常见的协议有Ethernet（IEEE802.3），在Ethernet中每台设备使用MAC地址作为唯一标识。最传统的**二层交换机**工作于该层，它不需要MAC地址，只需学习、检查各个端口发来的数据包的MAC并查表发送到对应端口即可
>
> `Network`**网络层**定义了网络中终端设备之间的数据传递，该层不提供可靠传输。IPv4以及IPv6是该层事实上的标准协议。**路由器**以及**三层交换机**工作于该层，这些网络设备每一个端口都需要有单独的MAC地址对应。通常所说的默认网关指的就是路由器
>
> `Transport`**传输层**定义了终端设备上**应用实体**之间的数据传输，该层通常需要为数据传输的可靠性提供支持，提供例如数据纠错，缓冲，传输控制等功能，常见的协议有`TCP`，`UDP`。TCP和UDP都使用端口机制。其中UDP由于其不可靠性，在实际中少有单独应用，通常都需要加上额外的包装才能为上层应用提供高效可靠的通信
>
> `Application`**应用层**常见的协议有HTTP，HTTPS，SMTP，IMAP，SSH等。这些应用层协议会调用特定的`Transport`传输层协议来实现自己的功能

> 之所以叫协议栈，是因为上层需要依赖于下层提供的服务才能运行。从二层交换机到路由器再到主机，这些设备可以处理的网络层级也越高。数据包装是层层嵌套的

![](images/221112a001.png)


## 2 常用评估指标

## 2.1 带宽（Bandwidth）

用于衡量单位时间内传输的数据量，也即容量Volume。单位`kbit/s` `Mbit/s`。在通信中使用**十进制**，以`bit`为基本计量单位，`1kb=1000b`，`1Mb=1000kb`

## 2.2 延迟（Latency）

数据从一个地方传送到另一个地方花费的时间，通常为`ms`级别。许多网络应用受延迟影响较大

## 2.3 错误率（Error Rate）

传输的误码率，如果网络通路良好，这个数值通常非常小，常见的计量单位有`bit/Gb`等。在实际应用中路由器和交换机等基础设施引入的处理延迟以及丢包才是影响普通用户使用体验的关键因素

## 3 数据链路层

## 3.1 Ethernet以太网

以太网是目前最为主流的链路层协议之一，数据使用以太网数据帧（数据包）的方式进行组织与传输

### 3.1.1 物理介质

以太网最早在1983年以IEEE802.3标准化。最早的以太网使用同轴电缆（coaxial）作为传输介质；后来发展出了如今最为常见的8芯双绞线，使用RJ45接口；以及光纤，常见光纤接口有SC，LC，ST等。以太网的基础设施主要有以太网交换机等。如果物理层使用了光纤，在交换机、路由器、网卡会添加额外的光接口，这些设备经常会使用可拆卸的光模块（SFP）

> 国内运营商光纤入户最常用EPON以及GPON，这些光网络除上网数据外还需要搭载IPTV，语音（座机）以及运营商管理等服务，普通的上网数据在PON网络上走以太网协议。此外连接运营商网络需要验证，只有运营商的光猫才能通过验证并成功联网。在GPON网络中，语音等服务会使用其他一些协议如ATM搭载。而EPON网络中语音也使用以太网数据帧搭载
>
> 多个邻近家庭/用户的网络一般通过分光器共享，分光器再向上连接运营商的OLT设备，这样就形成了多个ONT终端连接一个OLT的PON网络结构。这导致了上下行通信的不对称，从用户角度看下行使用广播的方式，而上行为了解决冲突问题使用TDMA时分复用
>
> 光纤的主要优点是材料成本低，抗干扰能力强，距离远。事实上光信号在光纤中的传导速度要慢于电信号在铜丝中的传导速度，而实际应用中各级路由器以及交换机带来的处理延迟才是更主要的影响因素

### 3.1.2 以太网帧格式

| 名称 | 长度 | 注解 |
| :-: | :-: | :-: |
| `Preamble` 前导 | `7` | 全`0x55`，用于双方同步时钟 |
| `SFD` 帧起始分隔符 | `1` | `0xD5`，标志以太网帧的起始 |
| `Destination MAC` 目标MAC | `6` | 接收端的MAC地址。`FF:FF:FF:FF:FF:FF`为广播地址，数据包会传输到网络上所有的机器并被接受 |
| `Source MAC` 源MAC | `6` | 发送端的MAC地址 |
| `802.1Q` VLAN标签 | `4` | **可选**，前2字节为`TPID`，通常为`0x8100`表示`802.1Q`，后2字节为`TCI`。`TCI[15:13]`为`PCP`用于规定优先级，`TCI[12]`为`DEI`表示数据包在拥塞时可以丢弃，`TCI[11:0]`为`VID`表示VLAN ID，可取范围`[1,4094]`。VLAN用于在一个物理以太网络中虚拟出多个网络，这些网络互不干涉 |
| `EtherType/Size` 上层协议/包大小 | `2` | 值取`[42,1500]`表示Payload的长度（单位Byte），值取`1536`及以上表示上层协议的类型 |
| `Payload` 数据载荷 |  | 长度可变，保证从目标MAC到`FCS`长度不小于`64`（CSMA/CD规定的最小长度）。有VLAN标签时`Payload`最短需要42字节 |
| `FCS` CRC校验码 | `4` | 使用CRC32，多项式`0x04C11DB7` |
| `Inter Frame Gap` 帧间隔 | `12` | 必须有的间隔，标志着数据帧的结束 |

![](images/221112a002.png)

> 以太网数据使用**大端传输**，但是单个Byte使用**LSB在前**的传输方法。例如上表中的`0x55`使用LSB在前的方式传输就会变成`0xAA`，分隔符`0xD5`会变成`0xAB`。只有`FCS`校验码使用**MSB在前**的传输方法

**MAC地址**

MAC地址由硬件厂商向IEEE申请后分配，在一个网络中用于标记一个唯一的接口。例如网卡，笔记本的有线和无线网卡拥有不同的MAC。有些网卡的MAC可以更改，如果一张网卡集成了多个网口，这些网口也会拥有不同的MAC。**网络和网络之间可以使用路由器进行分隔**，正常情况下一个网络内出现MAC冲突的几率非常小

MAC地址最高1字节的LSB（`I/G`）用于区分**单播**`0`或**多播**`1`（传输时该位首先传输），而最高1字节的倒数第2位（`U/L`）用于区分该地址是**全球唯一**`0`还是**本地唯一**`1`，所以我们平常看到的网卡MAC地址最高1字节都是4的倍数。如果用户明确指定，`U/L`可以会被设为`1`，例如在iPhone上开启*私有无线局域网地址*，就会使用这样的一个MAC地址

在实际应用中，如果不信任网络内的交换机/路由器，可以使用随机MAC防止恶意跟踪

日常生活中，在一个局域网内，我们访问外网只能通过默认的路由器（默认网关）。路由器是第三层网络设备，通过抓取网页浏览产生的数据流量，可以发现无论访问的IP地址如何变化，数据包的MAC地址永远都是默认网关端口的MAC和我们的网口MAC。以太网数据包从一个网络到另一个网络**需要路由器对MAC地址进行转换**。而二层交换机只负责单个网络内的数据流通（启用VLAN时除外），交换机本身不需要MAC地址，只需根据学习到的MAC将数据发送到对应的端口就可以了

在一个网络中，如果需要嗅探所有主机间的数据包，就需要开启网卡的**混杂模式**，否则网卡只会将符合自己MAC或广播MAC的数据包提交给上层。但是这种数据包嗅探方式对于使用二层交换机的网络而言是无效的，在使用网桥或以太网HUB的网络中才可用。类似地，`FCS`域的CRC校验码也由网卡自行处理，发生错误的直接将数据包丢弃。区别是数据包的`FCS`域**不会递交给上层**

**CRC校验**

IEEE802.3规定以太网的CRC32计算方法如下：

多项式`0x04C11DB7`，实际33位`0x104C11DB7`

![](images/221112a003.png)

> 计算CRC的关键点如下：
>
> CRC校验的区域包括2个MAC地址域，可选的VLAN标签域，`EtherType/Size`域，数据域以及数据域的占位符
>
> 校验区域的开头32位取补，数据左移32bit，进行计算
>
> 结果取补码，并且传输时使用大端，但是MSB在前

实际应用中网卡固件通常使用查表的优化算法，或直接硬件实现

**802.1Q优先级**

`802.1Q`定义`PCP`优先级以及对应关系如下

| 值 | 优先级 | 数据类型 |
| :-: | :-: | :-: |
| `1` | `0` | `BK` Background，最低优先级 |
| `0` | `1` | `BE` Best Effort |
| `2` | `2` | `EE` Excellent Effort |
| `3` | `3` | `CA` Critical Applications |
| `4` | `4` | `VI` Video，要求小于100ms延迟 |
| `5` | `5` | `VO` Voice，要求小于10ms延迟 |
| `6` | `6` | `IC` Internetwork Control |
| `7` | `7` | `NC` Network Control |

**常用EtherType上层协议类型**

| 值 | 协议 | 注释 |
| :-: | :-: | :-: |
| `0x0800` | `IPv4` |  |
| `0x0806` | `ARP`  | MAC地址解析 |
| `0x0842` | `Wake-on-LAN` | 网络唤醒 |
| `0x8100` | `IEEE802.1Q` | VLAN |
| `0x86DD` | `IPv6` |  |
| `0x8808` | `Ethernet flow control` | 流控制 |
| `0x8863` | `PPPoE Discovery Stage` |  |
| `0x8864` | `PPPoE Session Stage` |  |
| `0x88CC` | `LLDP` | Link Layer Discovery Protocol |

### 3.1.3 以太网设施：Repeater和Bridge

Repeater相当于一个没有数据缓冲的模拟放大器，它只是将每个端口发来的信号再发送到其他所有端口。以太网HUB就是相当于Repeater，同时有两个主机发送数据会发生冲突

Bridge网桥有数据缓冲，它会将所有端口发来的数据进行缓存，之后再依次从所有网口发出。Bridge大大减小了冲突带来的影响

### 3.1.4 以太网设施：二层交换机Switch

二层交换机Switch是最常用的以太网设施。它本质是一种特殊的网桥，交换机可以理解以太网帧的MAC地址。它会学习各个端口发来的数据包的`Source MAC`源MAC并把对应关系记录到一张表中。如果端口发来数据包的`Destination MAC`存在于表中，那么交换机就会将这个数据包发往对应的端口。如果`Destination MAC`不在表中，这个数据包可能会从所有端口发出

算法较为保守的交换机会缓存整个数据包，进行`CRC`检错后才会将数据包发送往对应端口

算法较为激进的交换机会在收到目标MAC后立即开始数据包的转发，此时由于发送方还未传输完毕所以无法进行`CRC`校验。这种交换机更为常用，需要更少的计算资源，包括缓存等，且拥有较小的延迟。但是纠错需要主机端来执行，且传输错误会导致更多的网络资源的浪费

### 3.1.5 CSMA/CD

CSMA/CD由网卡实现，全称**载波侦听多路访问/冲突检测**，这个协议广泛应用于通信领域用于解决物理层面的冲突，尤其是半双工物理信道，比如同轴电缆。但是由于支持物理全双工RJ45接口的交换机的流行，信道争用少了许多，这个算法的作用已经弱化了。而在使用了无缓冲以太网HUB（Repeater）的网络中，这种算法依旧发挥重要作用

> 关于CSMA/CD，需要记住2个点：一个是**载波监听**，也就是一个设备发送前对信道进行监听，发现没有其他设备在发送时才会发送数据。而由于数据在信道上传播时延的存在，单独的监听无法完全避免冲突，**冲突检测**就是边发送边检测冲突。假设一个数据信号从信道一端到另一端的时间为 $\tau$ ，那么争用期长度为 $2\tau$
>
> 假设A和B使用一根长铜线进行通信，A发送了一个数据，这个数据在到达B之前B恰好也发送了一个数据（B在此之前未监听到A发送消息），那么两个信号在铜线上将会发生冲突。假设AB支持发送时**冲突检测**，B在发现自己发送的数据和监测到的铜线的电平不一致，立刻判定冲突停止发送。而A需要在B发送的电信号到达自己这一端时才能检测到电平的不一致问题。所以争用期长度为 $2\tau$。A需要至少等到 $2\tau$ 以后才能判定数据未发生冲突。如果长铜线还连接了其他设备，那么发生冲突的几率会更高
>
> 在检测到冲突以后，发送方需要首先发送一串干扰信号，以便让网络内设备知道发生了冲突
>
> 从冲突中恢复时，需要等待一段随机长度的时间，防止再次发生冲突

常用的8芯双绞线支持物理全双工通信，收发线路分开。一条线缆只能将2个端口连接，收发可以并行。而网络的组建依赖于交换机、网桥或HUB。在这种以太网环境下，只有在多个设备向同一个设备发送数据时才会产生冲突的问题

交换机以及网桥由于拥有数据缓冲，基本解决了物理通信冲突的问题（缓冲溢出除外）。如果一个发往目标MAC地址A的数据包还未发送完，此时其他目标地址为A的数据包就只能在缓冲区等待

无缓冲的HUB中如果多个设备同时发送数据就会导致冲突，设备主要通过**载波监听**（监听RJ45接收端）规避冲突

## 3.2 ATM Asynchronous-Transfer-Mode

目前普通消费者购买的设备中已经很难再接触到ATM，原有的ATM应用领域大部分已经被Ethernet取代。ATM现今应用于一些有特殊要求的领域，在运营商的光网络中可以见到ATM，在GPON光网络中它用于搭载语音（从光猫连接出来的座机）

ATM的初衷就是降低通信的延迟，同时避免以太网中数据包乱序的问题。ATM基于虚拟线路`Virtual Circuit`设计，两个设备**在通信之前需要网络建立一条虚拟通路**。ATM使用`48`字节的定长数据包（这里称为Cell），数据包头长`5`字节，共`53`字节。之所以定为48字节是设计之初法国和美国的需求不同，最终在32字节和64字节取了中间数（~~结果谁也没得到好处~~）

ATM数据包格式如下

![](images/221112a004.png)

> ATM网络中用户到网络以及网络和网络之间使用的数据包是不相同的。用户到网络`UNI`数据包中`GFC`表示`Generic Flow Control`，没有实际作用永远为`0`。`VPI`为`Virtual Path ID`，长度1或1.5字节，`VCI`为`Virtual Channel ID`，长度2字节，这2个数据域表示该数据包下一个目的地。`PT`表示数据包类型，`0b1XX`表示数据包用于网络管理，`0b0XX`表示用户数据包，`0b01X`表示网络拥塞。`CLP`为丢包优先级，只有2级。`HEC`为`CRC`，使用多项式`0x107`进行校验

ATM基于虚拟线路的设计导致其较为混乱，且带宽分配缺乏灵活性。最终其大部分普通应用被以太网替代

## 4 网络层

## 4.1 IPv4

### 4.1.1 

## 4.2 IPv6

## 4.3 ARP

## 4.4 ICMP

## 4.5 路由器

## 5 传输层

传输层协议

## 5.1 TCP

## 5.2 UDP

## 5. QUIC

## 6 应用层

## 6.1 HTTP

## 6.2 HTTPS

## 6. DNS

## 6. DHCP

## 6. Telnet

## 6. FTP

## 6. SMTP

## 6. SNMP