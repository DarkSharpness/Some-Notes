# 计算机网络

## 目录

+ [**1**](#1-协议栈分层模型) 协议栈分层模型
+ [**2**](#2-常用评估指标) 常用评估指标
    + [**2.1**](#21-带宽bandwidth) 带宽（Bandwidth）
    + [**2.2**](#22-延迟latency) 延迟（Latency）
    + [**2.3**](#23-错误率error-rate) 错误率（Error Rate）
+ [**3**](#3-数据链路层) 数据链路层
    + [**3.1**](#31-ethernet以太网) Ethernet以太网
        + [**3.1.1**](#311-物理介质) 物理介质
        + [**3.1.2**](#312-以太网帧格式) 以太网帧格式
        + [**3.1.3**](#313-以太网设施repeater和bridge) 以太网设施：Repeater和Bridge
        + [**3.1.4**](#314-以太网设施二层交换机switch) 以太网设施：二层交换机Switch
        + [**3.1.5**](#315-csmacd) CSMA/CD
    + [**3.2**](#32-atm-asynchronous-transfer-mode) ATM Asynchronous-Transfer-Mode
+ [**4**](#4-网络层) 网络层
    + [**4.1**](#41-ipv4) IPv4
        + [**4.1.1**](#411-格式) 格式
        + [**4.1.2**](#412-ipv4地址类型与保留地址) IPv4地址类型与保留地址
        + [**4.1.3**](#413-子网划分和广播) 子网划分和广播
        + [**4.1.4**](#414-ipv4的问题和cidr) IPv4的问题和CIDR
    + [**4.2**](#42-ipv6) IPv6
        + [**4.2.1**](#421-格式) 格式
        + [**4.2.2**](#422-ipv6的地址分配机制) IPv6的地址分配机制
        + [**4.2.3**](#423-保留地址) 保留地址
        + [**4.2.4**](#424-ipv6多播地址) IPv6多播地址
    + [**4.3**](#43-路由原理) 路由原理
        + [**4.3.1**](#431-路由表) 路由表
        + [**4.3.2**](#432-路由协议) 路由协议
    + [**4.4**](#44-arp协议) ARP协议
    + [**4.5**](#45-ndp协议) NDP协议
    + [**4.6**](#46-nat) NAT
+ [**5**](#5-传输层) 传输层
    + [**5.1**](#51-tcp) TCP
    + [**5.2**](#52-udp) UDP
    + [**5.3**](#53-icmp和icmpv6) ICMP和ICMPv6
    + [**5.4**](#54-quic) QUIC
    + [**5.5**](#55-tls) TLS
+ [**6**](#6-应用层) 应用层
    + [**6.1**](#61-http) HTTP
    + [**6.2**](#62-https) HTTPS
    + [**6.3**](#63-dns) DNS
    + [**6.4**](#64-dhcp和dhcpv6) DHCP和DHCPv6
        + [**6.4.1**](#641-slaac) SLAAC
    + [**6.5**](#65-telnet) Telnet
    + [**6.6**](#66-ftp) FTP
    + [**6.7**](#67-smtp) SMTP
    + [**6.8**](#68-snmp) SNMP

## 1 协议栈分层模型

OSI分为7层，定义如下

| 层 | 名称 |
| :-: | :-: |
| `7` | Application 应用层 |
| `6` | Presentation 表示层 |
| `5` | Session 会话层 |
| `4` | Transport 传输层 |
| `3` | Network 网络层 |
| `2` | Datalink 数据链路层 |
| `1` | Physical 物理层 |

TCP/IP(DoD/ARPANet)是事实上的网络分层标准，分为5层（一说4层，无物理层），定义如下

| 层 | 名称 |
| :-: | :-: |
| `5` | Application 应用层 |
| `4` | Transport 传输层 |
| `3` | Network 网络层 |
| `2` | Datalink 数据链路层 |
| `1` | Physical 物理层 |

> `Physical`**物理层**定义了网络传输的物理媒介与连接，如同轴电缆，双绞线，光纤，无线电信号等，定义了实际的编码方式以及信号类型（例如互联方式，无线信号还是电信号或光信号，全双工还是半双工，差分信号还是非差分信号，以及这些信号的调制解调方法）。由于物理层类型繁多，且物理层中数据链路层数据可以和其他许多专有协议数据共存，如果不研究硬件，在4层模型中我们可以不用关注该层
>
> `Datalink`**数据链路层**定义了同一个网络中各元素之间的数据传递，常见的协议有Ethernet（IEEE802.3），在Ethernet中每台设备使用MAC地址作为唯一标识。最传统的**二层交换机**工作于该层，它不需要MAC地址，只需学习、检查各个端口发来的数据包的MAC并查表发送到对应端口即可
>
> `Network`**网络层**定义了网络中终端设备之间的数据传递，该层不提供可靠传输。IPv4以及IPv6是该层事实上的标准协议。**路由器**以及**三层交换机**工作于该层，这些网络设备每一个端口都需要有单独的MAC地址对应。通常所说的默认网关指的就是路由器
>
> `Transport`**传输层**定义了终端设备上**应用实体**之间的数据传输，该层通常需要为数据传输的可靠性提供支持，提供例如数据纠错，缓冲，传输控制等功能，常见的协议有`TCP`，`UDP`。TCP和UDP都使用端口机制。其中UDP由于其不可靠性，在实际中少有单独应用，通常都需要加上额外的包装才能为上层应用提供高效可靠的通信
>
> `Application`**应用层**常见的协议有HTTP，HTTPS，SMTP，IMAP，SSH等。这些应用层协议会调用特定的`Transport`传输层协议来实现自己的功能

> 之所以叫协议栈，是因为上层需要依赖于下层提供的服务才能运行。从二层交换机到路由器再到主机，这些设备可以处理的网络层级也越高。数据包装是层层嵌套的

![](images/221112a001.png)


## 2 常用评估指标

## 2.1 带宽（Bandwidth）

用于衡量单位时间内传输的数据量，也即容量Volume。单位`kbit/s` `Mbit/s`。在通信中使用**十进制**，以`bit`为基本计量单位，`1kb=1000b`，`1Mb=1000kb`

## 2.2 延迟（Latency）

数据从一个地方传送到另一个地方花费的时间，通常为`ms`级别。许多网络应用受延迟影响较大

## 2.3 错误率（Error Rate）

传输的误码率，如果网络通路良好，这个数值通常非常小，常见的计量单位有`bit/Gb`等。在实际应用中路由器和交换机等基础设施引入的处理延迟以及丢包才是影响普通用户使用体验的关键因素

## 3 数据链路层

## 3.1 Ethernet以太网

以太网是目前最为主流的链路层协议之一，数据使用以太网数据帧（数据包）的方式进行组织与传输

### 3.1.1 物理介质

以太网最早在1983年以IEEE802.3标准化。最早的以太网使用同轴电缆（coaxial）作为传输介质；后来发展出了如今最为常见的8芯双绞线，使用RJ45接口；以及光纤，常见光纤接口有SC，LC，ST等。以太网的基础设施主要有以太网交换机等。如果物理层使用了光纤，在交换机、路由器、网卡会添加额外的光接口，这些设备经常会使用可拆卸的光模块（SFP）

> 国内运营商光纤入户最常用EPON以及GPON，这些光网络除上网数据外还需要搭载IPTV，语音（座机）以及运营商管理等服务，普通的上网数据在PON网络上走以太网协议。此外连接运营商网络需要验证，只有运营商的光猫才能通过验证并成功联网。在GPON网络中，语音等服务会使用其他一些协议如ATM搭载。而EPON网络中语音也使用以太网数据帧搭载
>
> 多个邻近家庭/用户的网络一般通过分光器共享，分光器再向上连接运营商的OLT设备，这样就形成了多个ONT终端连接一个OLT的PON网络结构。这导致了上下行通信的不对称，从用户角度看下行使用广播的方式，而上行为了解决冲突问题使用TDMA时分复用
>
> 光纤的主要优点是材料成本低，抗干扰能力强，距离远。事实上光信号在光纤中的传导速度要慢于电信号在铜丝中的传导速度，而实际应用中各级路由器以及交换机带来的处理延迟才是更主要的影响因素

### 3.1.2 以太网帧格式

| 名称 | 长度（Byte） | 注解 |
| :-: | :-: | :-: |
| `Preamble` 前导 | `7` | 全`0x55`，用于双方同步时钟 |
| `SFD` 帧起始分隔符 | `1` | `0xD5`，标志以太网帧的起始 |
| `Destination MAC` 目标MAC | `6` | 接收端的MAC地址。`FF:FF:FF:FF:FF:FF`为广播地址（**此外还有组播MAC，这里省略**），数据包会传输到网络上所有的机器并被接受 |
| `Source MAC` 源MAC | `6` | 发送端的MAC地址 |
| `802.1Q` VLAN标签 | `4` | **可选**，前2字节为`TPID`，通常为`0x8100`表示`802.1Q`，后2字节为`TCI`。`TCI[15:13]`为`PCP`用于规定优先级，`TCI[12]`为`DEI`表示数据包在拥塞时可以丢弃，`TCI[11:0]`为`VID`表示VLAN ID，可取范围`[1,4094]`。VLAN用于在一个物理以太网络中虚拟出多个网络，这些网络互不干涉 |
| `EtherType/Size` 上层协议/包大小 | `2` | 值取`[42,1500]`表示Payload的长度（单位Byte），值取`1536`及以上表示上层协议的类型 |
| `Payload` 数据载荷 |  | 长度可变，保证从目标MAC到`FCS`长度不小于`64`（CSMA/CD规定的最小长度）。有VLAN标签时`Payload`最短需要42字节 |
| `FCS` CRC校验码 | `4` | 使用CRC32，多项式`0x04C11DB7` |
| `Inter Frame Gap` 帧间隔 | `12` | 必须有的间隔，标志着数据帧的结束 |

![](images/221112a002.png)

> 以太网数据使用**大端传输**，但是单个Byte使用**LSB在前**的传输方法。例如上表中的`0x55`使用LSB在前的方式传输就会变成`0xAA`，分隔符`0xD5`会变成`0xAB`。只有`FCS`校验码使用**MSB在前**的传输方法

**MAC地址**

MAC地址由硬件厂商向IEEE申请后分配，在一个网络中用于标记一个唯一的接口。例如网卡，笔记本的有线和无线网卡拥有不同的MAC。有些网卡的MAC可以更改，如果一张网卡集成了多个网口，这些网口也会拥有不同的MAC。**网络和网络之间可以使用路由器进行分隔**，正常情况下一个网络内出现MAC冲突的几率非常小

MAC地址最高1字节的LSB（`I/G`）用于区分**单播**`0`或**多播**`1`（传输时该位首先传输），而最高1字节的倒数第2位（`U/L`）用于区分该地址是**全球唯一**`0`还是**本地唯一**`1`，所以我们平常看到的网卡MAC地址最高1字节都是4的倍数。如果用户明确指定，`U/L`可以会被设为`1`，例如在iPhone上开启*私有无线局域网地址*，就会使用这样的一个MAC地址

在实际应用中，如果不信任网络内的交换机/路由器，可以使用随机MAC防止恶意跟踪

日常生活中，在一个局域网内，我们访问外网只能通过默认的路由器（默认网关）。路由器是第三层网络设备，通过抓取网页浏览产生的数据流量，可以发现无论访问的IP地址如何变化，数据包的MAC地址永远都是默认网关端口的MAC和我们的网口MAC。以太网数据包从一个网络到另一个网络**需要路由器对MAC地址进行转换**。而二层交换机只负责单个网络内的数据流通（启用VLAN时除外），交换机本身不需要MAC地址，只需根据学习到的MAC将数据发送到对应的端口就可以了

在一个网络中，如果需要嗅探所有主机间的数据包，就需要开启网卡的**混杂模式**，否则网卡只会将符合自己MAC或广播MAC的数据包提交给上层。但是这种数据包嗅探方式对于使用二层交换机的网络而言是无效的，在使用网桥或以太网HUB的网络中才可用。类似地，`FCS`域的CRC校验码也由网卡自行处理，发生错误的直接将数据包丢弃。区别是数据包的`FCS`域**不会递交给上层**

**CRC校验**

IEEE802.3规定以太网的CRC32计算方法如下：

多项式`0x04C11DB7`，省略最高位实际33位`0x104C11DB7`

![](images/221112a003.png)

> 计算CRC的关键点如下：
>
> CRC校验的区域包括2个MAC地址域，可选的VLAN标签域，`EtherType/Size`域，数据域以及数据域的占位符
>
> 校验区域的开头32位取补，数据左移32bit，进行计算
>
> 结果取补码，并且传输时使用大端，但是MSB在前

实际应用中网卡固件通常使用查表的优化算法，或直接硬件实现

**802.1Q优先级**

`802.1Q`定义`PCP`优先级以及对应关系如下

| 值 | 优先级 | 数据类型 |
| :-: | :-: | :-: |
| `1` | `0` | `BK` Background，最低优先级 |
| `0` | `1` | `BE` Best Effort |
| `2` | `2` | `EE` Excellent Effort |
| `3` | `3` | `CA` Critical Applications |
| `4` | `4` | `VI` Video，要求小于100ms延迟 |
| `5` | `5` | `VO` Voice，要求小于10ms延迟 |
| `6` | `6` | `IC` Internetwork Control |
| `7` | `7` | `NC` Network Control |

**常用EtherType上层协议类型**

| 值 | 协议 | 注释 |
| :-: | :-: | :-: |
| `0x0800` | `IPv4` |  |
| `0x0806` | `ARP`  | MAC地址解析 |
| `0x0842` | `Wake-on-LAN` | 网络唤醒 |
| `0x8100` | `IEEE802.1Q` | VLAN |
| `0x86DD` | `IPv6` |  |
| `0x8808` | `Ethernet flow control` | 流控制 |
| `0x8863` | `PPPoE Discovery Stage` |  |
| `0x8864` | `PPPoE Session Stage` |  |
| `0x88CC` | `LLDP` | Link Layer Discovery Protocol |

### 3.1.3 以太网设施：Repeater和Bridge

Repeater相当于一个没有数据缓冲的模拟放大器，它只是将每个端口发来的信号再发送到其他所有端口。以太网HUB就是相当于Repeater，同时有两个主机发送数据会发生冲突

Bridge网桥有数据缓冲，它会将所有端口发来的数据进行缓存，之后再依次从所有网口发出。Bridge大大减小了冲突带来的影响

### 3.1.4 以太网设施：二层交换机Switch

二层交换机Switch是最常用的以太网设施。它本质是一种特殊的网桥，交换机可以理解以太网帧的MAC地址。它会学习各个端口发来的数据包的`Source MAC`源MAC并把对应关系记录到一张表中。如果端口发来数据包的`Destination MAC`存在于表中，那么交换机就会将这个数据包发往对应的端口。如果`Destination MAC`不在表中，这个数据包可能会从所有端口发出

算法较为保守的交换机会缓存整个数据包，进行`CRC`检错后才会将数据包发送往对应端口

算法较为激进的交换机会在收到目标MAC后立即开始数据包的转发（这也是将目标MAC放在开头的原因），此时由于发送方还未传输完毕所以无法进行`CRC`校验。这种交换机更为常用，需要更少的计算资源，包括缓存等，且拥有较小的延迟。但是纠错需要主机端来执行，且传输错误会导致更多的网络资源的浪费

### 3.1.5 CSMA/CD

CSMA/CD由网卡实现，全称**载波侦听多路访问/冲突检测**，这个协议广泛应用于通信领域用于解决物理层面的冲突，尤其是半双工物理信道，比如同轴电缆。但是由于支持物理全双工RJ45接口的交换机的流行，信道争用少了许多，这个算法的作用已经弱化了。而在使用了无缓冲以太网HUB（Repeater）的网络中，这种算法依旧发挥重要作用

> 关于CSMA/CD，需要记住2个点：一个是**载波监听**，也就是一个设备发送前对信道进行监听，发现没有其他设备在发送时才会发送数据。而由于数据在信道上传播时延的存在，单独的监听无法完全避免冲突，**冲突检测**就是边发送边检测冲突。假设一个数据信号从信道一端到另一端的时间为 $\tau$ ，那么争用期长度为 $2\tau$
>
> 假设A和B使用一根长铜线进行通信，A发送了一个数据，这个数据在到达B之前B恰好也发送了一个数据（B在此之前未监听到A发送消息），那么两个信号在铜线上将会发生冲突。假设AB支持发送时**冲突检测**，B在发现自己发送的数据和监测到的铜线的电平不一致，立刻判定冲突停止发送。而A需要在B发送的电信号到达自己这一端时才能检测到电平的不一致问题。所以争用期长度为 $2\tau$。A需要至少等到 $2\tau$ 以后才能判定数据未发生冲突。如果长铜线还连接了其他设备，那么发生冲突的几率会更高
>
> 在检测到冲突以后，发送方需要首先发送一串干扰信号，以便让网络内设备知道发生了冲突
>
> 从冲突中恢复时，需要等待一段随机长度的时间，防止再次发生冲突

常用的8芯双绞线支持物理全双工通信，收发线路分开。一条线缆只能将2个端口连接，收发可以并行。而网络的组建依赖于交换机、网桥或HUB。在这种以太网环境下，只有在多个设备向同一个设备发送数据时才会产生冲突的问题

交换机以及网桥由于拥有数据缓冲，基本解决了物理通信冲突的问题（缓冲溢出除外）。如果一个发往目标MAC地址A的数据包还未发送完，此时其他目标地址为A的数据包就只能在缓冲区等待

无缓冲的HUB中如果多个设备同时发送数据就会导致冲突，设备主要通过**载波监听**（监听RJ45接收端）规避冲突

## 3.2 ATM Asynchronous-Transfer-Mode

目前普通消费者购买的设备中已经很难再接触到ATM，原有的ATM应用领域大部分已经被Ethernet取代。ATM现今应用于一些有特殊要求的领域，在运营商的光网络中可以见到ATM，在GPON光网络中它用于搭载语音服务（从光猫连接出来的座机）

ATM的初衷就是降低通信的延迟，同时避免类似以太网中数据包乱序的问题。ATM基于虚拟线路`Virtual Circuit`设计，两个设备**在通信之前需要网络建立一条虚拟通路**。ATM使用`48`字节的定长数据包（这里称为Cell），Header长`5`字节，共`53`字节。之所以定为48字节是设计之初法国和美国的需求不同，最终在32字节和64字节取了中间数（~~结果谁也没得到好处~~）

ATM数据包格式如下

![](images/221112a004.png)

> ATM网络中用户到网络以及网络和网络之间使用的数据包是不相同的。用户到网络`UNI`数据包中`GFC`表示`Generic Flow Control`，没有实际作用永远为`0`。`VPI`为`Virtual Path ID`，长度1或1.5字节，`VCI`为`Virtual Channel ID`，长度2字节，这2个数据域表示该数据包下一个目的地。`PT`表示数据包类型，`0b1XX`表示数据包用于网络管理，`0b0XX`表示用户数据包，`0b01X`表示网络拥塞。`CLP`为丢包优先级，只有2级。`HEC`为`CRC`，使用多项式`0x107`进行校验

ATM基于虚拟线路的设计导致其较为混乱，资源分配效率低，且带宽分配缺乏灵活性。最终其大部分普通应用被以太网替代

## 4 网络层

网络层用于站点到站点之间的数据传输。目前几乎全部的设备在网络层都使用IPv4以及IPv6

IP协议处于以太网更高一层网络。和MAC地址不同，一个数据包在不同网络之间传输，它的源IP和目标IP是不会改变的。**经过NAT路由时除外**

参考RFC791以及RFC1122

## 4.1 IPv4

IPv4数据包的以太网帧`EtherType`为`0x0800`，使用32位表示一个站点，格式`XXX.XXX.XXX.XXX`

### 4.1.1 格式

在RFC791中定义如下

```
    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version|  IHL  |Type of Service|          Total Length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Identification        |Flags|      Fragment Offset    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Time to Live |    Protocol   |         Header Checksum       |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                       Source Address                          |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Destination Address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                    Options                    |    Padding    |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

                    Example Internet Datagram Header
```

**Word 1**

| 名称 | 长度（bit） | 注解 |
| :-: | :-: | :-: |
| `Version` | `4` | IP版本，这里是`0x4` |
| `IHL`  | `4` | IP Header长度，使用4Byte为单位计数。如果IP Header没有`Options`那么这里为`0x5`，长20字节 |
| `ToS`  | `8` | 服务类型。由于没有明确标准，不常用，为`0x00`。高3位表示数据包的传输优先级，接下来3位依次表示延迟、吞吐、可靠性要求 |
| `Total Length`  | `16` | 总长度，使用字节计数，是包含IP Header的总长度（最长65535字节，64kB） |

**Word 2**

| 名称 | 长度（bit） | 注解 |
| :-: | :-: | :-: |
| `Identification` | `16` | 在分包时常用。一个数据包可以拆分成多个Fragment再传输，这个区域表示当前Fragment所属组（通常是同一个数据包）。大数据包传送到仅支持小数据包的网络中，如果网关（路由器）支持拆包就会分拆后传输 |
| `Flags` | `3` | `0b010`表示禁止拆分，`0b000`表示最后一个Fragment，`0b001`表示还有后续Fragment。如果接收方不支持Fragment拼接，可以规定数据包不允许拆分 |
| `Fragment Offset` | `13` | 表示Fragment在数据包中的偏移（起始地址），以8Byte为单位计数 |

**Word 3**

| 名称 | 长度（bit） | 注解 |
| :-: | :-: | :-: |
| `Time to Live` | `8` | `TTL`，数据包每经过一个路由器都会减1。目前大部分操作系统默认使用`64`作为初始值。如果一个数据包在传输过程中`TTL`减小到`0`，说明经过了太多的路由器，路由器会直接丢弃该包并向发送方发送一个`ICMP Time Exceeded`报文。Linux下常用的`tracepath`就应用了`TTL`（逐次递增）来计算大致的路由路径 |
| `Protocol` | `8` | 数据包搭载的传输层协议。`1`为`ICMP`，`6`为`TCP`，`17`为`UDP` |
| `Header Checksum` | `16` | Header的校验码，不包括之后的数据。这里的校验码计算非常简单（RFC1701），将原先的Checksum置0，Header以2Byte为单位分割后相加，单次加法后进位再加到最低位。最终结果取反码就是校验码。由于路由器需要更改`TTL`，所以路由器每次都要重新计算校验码 |

**Word 4 & 5**

| 名称 | 长度（bit） | 注解 |
| :-: | :-: | :-: |
| `Source Address` | `32` | 源地址 |
| `Destination Address` | `32` | 目标地址 |

**Word 5+**

| 名称 | 长度（bit） | 注解 |
| :-: | :-: | :-: |
| `Options` | 不定 | 基本不使用，会被一些路由器直接丢弃 |

> 在实际的应用中，分包不是很常用。一旦有一个Fragment出现错误整个数据包就不得不重新传输，IPv6废除了分包功能。且分包对于部分传输层的设备来说不友好。`MTU`表示`Media Transmission Unit`或`Maximum Transmission Unit`，最大的传输单元
>
> `TTL`的主要作用就是为网络中的数据包规定一个有限的生命周期，数据包如果在限定时间内未到达目的地会被丢弃而不是无限转发。没有`TTL`数据包就会永远留存在网络中

### 4.1.2 IPv4地址类型与保留地址

世界最大的网络是Internet。IPv4地址分为ABCDE共5大Class，其中有许多IP地址保留，不可分配用于公网IP

IPv4本没有Class之分，后来为满足不同机构、企业的需求才进行了5种类型的划分，且这种划分是针对于Internet而言的。离开了Internet谈Class也就没有意义了

**Class A**

A类地址二进制以`0`开头，第1字节表示网络，后3字节表示主机。理论上可以提供128个`Class A`网络`0.0.0.0/8`到`127.0.0.0/8`，每个网络2^24台主机

实际上`0.0.0.0/8`保留表示当前网络，`127.0.0.0/8`保留用于回环`loopback`（通常使用地址`127.0.0.1`），`10.0.0.0/8`保留用于**私有网络**（和局域网不是一个概念）。`100.0.0.0/8`的子网络地址`100.64.0.0/10`保留用于运营商私有网络

**Class B**

B类地址二进制以`10`开头，前2字节表示网络，后2字节表示主机。理论上可以提供16384个`Class B`网络`128.0.0.0/16`到`191.255.0.0/16`，每个网络2^16台主机

实际上`172.16.0.0/12`（网络`172.16.0.0/16`到网络`172.31.0.0/16`）保留用于**私有网络**，`169.254.0.0/16`保留用于`link-local address`（典型例子是没有手动配置IP且DHCP失败，此时主机会默认给自己指定的IP。在网络故障时经常可以见到这个IP）

**Class C**

C类地址二进制以`110`开头，前3字节表示网络，后1字节表示主机。理论上可以提供2^21个`Class C`网络`192.0.0.0/24`到`223.255.255.0/24`，每个网络2^8台主机

实际上`192.0.2.0/24` `198.51.100.0/24` `203.0.113.0/24`保留用于特殊用途（TEST-NET），`192.88.99.0/24`保留用于IPv6到IPv4中继，`192.168.0.0/16`（网络`192.168.0.0/24`到网络`192.168.255.0/24`）和`192.0.0.0/24`保留用于**私有网络**，`198.18.0.0/15`（网络`198.18.0.0/24`到网络`198.19.255.0/24`）保留用于测试

**Class D**

D类地址二进制以`1110`开头，用于多播。地址范围`224.0.0.0`到`239.255.255.255`

其中`233.252.0.0/24`用于特殊用途（MCAST-TEST-NET）

**Class E**

E类地址二进制以`1111`开头，保留用途。地址范围`240.0.0.0`到`255.255.255.255`

其中地址`255.255.255.255`用于limited broadcast

### 4.1.3 子网划分和广播

在一个网络中，路由器和每台主机都会有自己的子网掩码，形式类似于`255.255.240.0`，前段全为二进制`1`表示IP地址网络字段域，后段全为二进制`0`表示IP地址主机字段域

在每一个子网中，主机地址全`0`表示网络地址，全`1`表示广播地址，这两个地址**不可以分配给主机或路由器端口**。例如私有网络`192.168.0.0/16`配置子网掩码`255.255.240.0`，那么一共划分为子网`192.168.0.0/20`到`192.168.240.0/20`，这些子网络拥有各自的广播IP和网络IP。注意IP广播数据包需要将目标MAC地址域也设为`FF:FF:FF:FF:FF:FF`广播地址，IP组播数据包需要将目标MAC地址设为对应的组播MAC地址

所谓广播就是一个网络中的所有设备都会接受的网络层广播数据包。过多的设备使用同一个广播地址容易引发**广播风暴**，此时可以使用三层交换机并进行子网划分，配合VLAN使用

实际在同一个网络中，路由器端口以及各主机端口的子网掩码习惯上配置一致，否则会引发一些奇怪的问题。使用`DHCP`时会指定所有主机使用相同的子网掩码配置

> 子网掩码不是IP数据包的组成部分，它不会在设备之间传输。在一个网络中，主机和路由器还是有可能配置不同的子网掩码的，但是会出现很多问题

> 假设这样一个典型的网络，网络通过交换机构建。有一台路由器的一个端口连接到了这个网络，此外还有主机A以及主机B连接到了这个网络
>
> 路由器设定自己的端口IP为`192.168.1.1`，子网掩码`255.255.255.0`。而A设定自己的端口IP为`192.168.1.243`，子网掩码`255.255.240.0`。B设定自己的端口IP为`192.168.1.192`，子网掩码`255.255.255.240`
>
> 首先，此时路由器广播地址`192.168.1.255`，A广播地址`192.168.15.255`，B广播地址`192.168.1.207`。此时任意两者之间无法接收对方发送的IP广播
>
> 此外，如果想要通过A访问B，A将B的地址和自己的子网掩码进行与运算后发现B和自己处于同一网段。于是A不再将数据发往自己的默认网关，而根据`ARP`协议发送一个数据链路层广播，要求询问`192.168.1.192`的MAC地址并告诉`192.168.1.243`，同时给出自己的MAC地址。此时B收到了这个广播，并将`192.168.1.243`和自己的子网掩码进行与运算，发现和自己不是同一个网段，于是B将`ARP`数据包丢弃。因此A是无法访问B的
>
> 反过来如果不为B配置默认网关，通过B也无法访问A。此时B认为A和自己不在一个网段，于是决定将数据包直接发送给路由器，但是当前B所属的子网中没有可用的路由

> 同一个交换机连接的设备可以属于不同的IP子网，但是没有路由器的情况下不同子网之间通常是无法通信的（除非子网掩码配置不同，导致不同大小的子网出现重叠。特定的地址之间可以进行单向或双向通信，只要双方发现对方和自己同一个网段）。`ARP`协议中主机会丢弃不属于自己网段的`ARP`广播数据包

> 在路由器的同一个端口是有可能绑定多个IP的，只要路由器支持，可以为不同的子网分别提供默认网关（和单臂路由工作原理类似），当然路由器中端口的IP也必须要有正确的子网掩码配置，否则主机`ARP`请求默认网关会失败
>
> 通常子网划分会和VLAN一起使用。单臂路由就使用VLAN分隔WAN和LAN的数据流

### 4.1.4 IPv4的问题和CIDR

历史原因，IPv4的地址没有得到高效的分配。许多A类B类网络地址被分配给了单个机构，如MIT，Stanford，惠普等，而这些机构通常没有能力消耗如此多的IP地址

IPv4诞生于1980年代，受冷战影响，Internet发展起来以后北美、西欧以外的地区普遍面临IP短缺的问题，在亚洲地区尤为严重。大部分国家如中国只能通过组建大型NAT局域网来缓解（这也是我们查看家庭光猫后台时发现IP地址为运营商局域网地址`10.X.X.X`或`100.X.X.X`的原因，真正的公网IP分配给了运营商的上游网关）。家庭网无法搭建网站，而访问家庭网内的设备需要一对公网、内网设备进行内网穿透，通过公网设备的代理服务才能访问

为解决ABC类网络主机数量过于悬殊无法充分分配的问题，以及路由表过大的问题，实际上现在Internet已经不再遵循ABC类网络的划分了，转而使用了类似于`IPv6`思路的`CIDR`（Classless Inter-Domain Routing）无Class划分，见RFC4632。为方便理解，本文依然遵照旧有的Classful网络讲述，这里只简单对`CIDR`进行一些说明

`CIDR`规定了IP地址由可变长度的网络地址以及随后的主机地址构成。例如`122.23.4.252/12`的网络前缀长`12`，对应的主机地址长`20`。由于使用`CIDR`后路由器无法确定一个IP的网络地址，所以要求在路由器协议中都要包含网络地址长度（或掩码），现在OSPF，IS-IS，RIPv2，EIGRP，BGP4路由协议都支持`CIDR`。**旧有的路由设备除非进行固件的升级，否则不能再用于Internet**

现在公网的地址分配也遵照`CIDR`，由IANA统一分配给RIR后再分配到用户。最小的多主机网络需要`/29`，`/28`到`/26`是小型局域网，`/25`和`/24`是大型局域网，`/22`为小型单位，`/21`和`/20`给大型单位和小型运营商，`/8`是最大的可分配网络

## 4.2 IPv6

IPv6的出现主要是为了解决IPv4的枯竭问题，它的应用对于IP地址紧张的地区来说意义重大。IPv6使得网络中每一个设备都可以拥有公网IP。然而IPv6是面向未来设计的，许多协议远比IPv4复杂，它的工作机制和IPv4不相容；也由于网络基础设施的更新换代问题，在未来很长一段时间内IPv4将会和IPv6共存。兼容两种网络的工作量是巨大的

IPv6数据包的以太网帧`EtherType`为`0x86DD`，使用128位表示一个站点。格式为16进制`XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX:XXXX`省略前导0。如果有多个16位`0`，这片区域使用`::`代替，例如`fe43:15dd:2e3f:32a:5c66::43eb`中间`::`处省略了`0000:0000`

和IPv4将地址分配给网络中的节点略有不同，IPv6地址的分配对象是网络中的（逻辑上的）接口。也就是说，理论上可以给主机上的每一个进程分配一个IPv6地址。具体内容见[4.2.2](#422-ipv6的地址分配)以及RFC4291

### 4.2.1 格式

在RFC2460中定义如下

```
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Version| Traffic Class |           Flow Label                  |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |         Payload Length        |  Next Header  |   Hop Limit   |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                         Source Address                        +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                      Destination Address                      +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

| 名称 | 长度（bit） | 注解 |
| :-: | :-: | :-: |
| `Version`  | `4` | IP版本，固定值`6` |
| `Traffic Class`  | `8` | 数据包等级，相当于`ToS`，没有权威定义不常使用。默认全`0` |
| `Flow Label`  | `20` | 数据流标签，标记相关的数据，路由器以此可以保证固定的传输路径，没有权威定义不常使用。默认全`0` |
| `Payload Length` | `16` | 搭载的数据的长度，单位Byte，即目标地址后的数据长度 |
| `Next Header` | `8` | 搭载协议，同IPv4的`Protocol`，表示搭载的传输层协议。此外IPv6中还可以表示`Routing header`等非传输层相关数据 |
| `Hop Limit` | `8` | 同IPv4的`TTL` |
| `Source Address` | `128` | 源地址 |
| `Destination Address` | `128` | 目标地址 |

> 相对IPv4来说，IPv6的数据帧结构简单了许多，且没有校验码。在IPv6网络中要求UDP数据包需要有校验码
>
> IPv6通常要求网络的`MTU`在`1280`或以上

### 4.2.2 IPv6的地址分配机制

> 最早的IPv4本是没有NAT和私有网络的概念的，这些功能主要是为应对IPv4地址紧缺问题而扩展出来的（本质就是用传输层TCP或UDP的端口号来扩展IP）。不要认为局域网一定要使用私有网络地址（如`192.168.0.0`），局域网也可以是公网

IPv6地址多达128位，如此多的地址是严重过剩的。为了充分利用，IPv6规定其地址分配的最小细粒度是**网络接口**（`interface`）而非**节点**（`node`）。前64位`/64`为**节点地址**，后64位为节点的**网络接口地址**。这里的接口同样是逻辑上的接口，不是物理上的接口

主机在分配到一个IPv6节点地址以后，可以使用任意的网络接口地址表示自己这个节点本身，从而自行填充剩余64位网络接口地址。例如直接使用MAC填充，或对MAC进行哈希后填充。而主机上的每一个进程也可以拥有一个相同节点地址下的网络接口地址，但是这和TCP、UDP的接口机制有部分功能上的重合

IPv6也支持类似IPv4的子网划分（prefix）。现在通常家庭网会分配prefix为`/56`或`/48`的网络，分别允许`256`或`65536`台主机，而企业会分配`/48`或`/44`或`/40`。IPv6下不需要私有网络以及NAT来解决公网地址不够的问题，每一台主机都可以拥有公网IP

### 4.2.3 保留地址

| 保留地址 | 用途 |
| :-: | :-: |
| `::/0` | 未指定时使用的默认网关配置 |
| `::/128` | 未初始化 |
| `::1/128` | 回环地址 |
| `::ffff:0:0/96` | 最后4字节网络接口地址，用于映射32位IPv4地址 |
| `::ffff:0:0:0/96` | 最后4字节网络接口地址，用于32位IPv4地址转译（转译算法有多种，各不相同） |
| `fc00::/7` | 私有网络地址，其中`fc00::/8`保留，`fd00::/8`中prefix长`/48`，子网长`/16` |
| `ff00::/8` | 多播地址 |
| `fe80::/10` | Link-local address。这种地址用于单个网络中，路由器分隔的两个网络无法通过该类型地址通信，`NDP`以及`DHCPv6`协议都会使用到它。通常IPv6设备都会配置这样的一个地址，也是因此我们经常发现IPv6设备有2个地址 |
| `64:ff9b::/96` | 公网中用于IPv4IPv6互转 |
| `64:ff9b:1::/48` | 局域网中用于IPv4IPv6互转 |
| `100::/64` | Discard |
| `2001:0000::/32` | Teredo tunneling |
| `2001:20::/28` | ORCHIDv2 |
| `2001:db8::/32` | 文档保留 |
| `2002::/16` | 弃用 |

### 4.2.4 IPv6多播地址

IPv6中只有多播以及任播（`Anycast`，传输到最近的1台设备），而没有广播。多播涵盖了广播的功能，**IPv6组播时需要使用组播MAC地址而不是广播MAC地址**

IPv6多播地址历史上经历过多次演变。定义如下，多播地址第一字节永远为`ff`

```
RFC4291

   |   8    |  4 |  4 |                  112 bits                   |
   +------ -+----+----+---------------------------------------------+
   |11111111|flgs|scop|                  group ID                   |
   +--------+----+----+---------------------------------------------+

Flags

   +-+-+-+-+
   |0|R|P|T|
   +-+-+-+-+
```

`flags`最高1位保留为`0`，后3位依次为`R P T`。其中`R`表示`Rendezvous`，Rendezvous Point字面意义**汇合点**简称`RP`，`R`为`1`时表示当前地址集成了`RP`地址（见下）；`P`表示`Prefix`，为`1`表示由`network prefix`定义多播地址（同样见下）；`T`表示`Transient(Non-permanent)`，为`1`时表示不是由国际组织分配的多播地址。`P`为`1`时`T`也一定为`1`（固定的多播地址可以由IANA分配）

`scope`表示多播组的涉及范围，`group ID`指定了`scope`网络范围内的组ID。`scope`定义如下

```
0  reserved
1  Interface-Local scope
2  Link-Local scope
3  reserved
4  Admin-Local scope
5  Site-Local scope
6  (unassigned)
7  (unassigned)
8  Organization-Local scope
9  (unassigned)
A  (unassigned)
B  (unassigned)
C  (unassigned)
D  (unassigned)
E  Global scope
F  reserved
```

常用IPv6组播地址如下

```
ff02::1 本网络内所有设备（节点）
ff02::2 本网络内所有路由
ff02::1:ffXX:XXXX 本网络内被请求对象的组播地址
```

> 组播地址`ff02::1:ffXX:XXXX`中最后3字节（24bit）取当前端口IP的后24位
>
> 需要首先计算出组播IP地址才能确定组播MAC地址。组播MAC地址格式为`33:33:XX:XX:XX:XX`，后4字节和组播IP地址的后4字节相同

`RP`地址计算方法如下

```
   |   8    |  4 |  4 |  4 |  4 | 8  |       64       |    32    |
   +--------+----+----+----+----+----+----------------+----------+
   |11111111|flgs|scop|rsvd|RIID|plen| network prefix | group ID |
   +--------+----+----+----+----+----+----------------+----------+

RP address

   +------------+---------------------+----+
   | network pre| 0000000000000000000 |RIID|
   +------------+---------------------+----+
```

> 在`R`为`1`时`P`和`T`也需要为`1`（`0xff7x`）。`RP`地址通常是一个IPv6路由器的地址，这个路由器负责数据源发来的多播数据包的分流转发。例如距离网络电视服务器最近的路由器就需要具备这种功能，而途径的路由器也需要支持这些功能。`RP`地址的构建需要`plen` `network prefix` `RIID`共三个部分，其中`RIID`放在128位IPv6的最后表示`RP`的`interface`，而`plen`指定`network prefix`的长度，截取后放在最前面。`plen`不大于64

## 4.3 路由原理

### 4.3.1 路由表

路由器是第三层网络设备，它的本质就是一种只能理解到网络层的特殊的主机（现在的路由器也可以理解更高层）。它和主机的不同点是它至少拥有2个网络接口，需要连接到不同的网络进行网络之间的数据转发，而主机只需要1个接口连接到网络就可以（家用路由器通常集成交换机，引出多个LAN接口，通常只能算路由器的一个接口）。路由器连接不同网络的每一个端口都拥有独立的MAC地址，数据包通过路由器转发时需要更改MAC地址为路由器转发接口的MAC。防火墙可以算一种特殊的路由器，具备更多的安全功能

在[本章开头](#4-网络层)说过，如果没有NAT的特殊情况，数据包在不同网络之间，穿过路由器传输时**源IP和目标IP是不会改变的**，只有数据链路层的MAC地址会不断改变。主机通常会配置默认网关（路由器）IP，发送数据包时它会判断目标IP是否属于当前已经连接的网络，如果**属于已连接网络**只需设置好目标MAC地址直接发送数据包；如果**不属于**已有网络，主机会将MAC地址设置为默认网关或对应路由器的MAC，将数据包发送给路由器转发处理

每台主机都拥有一个路由配置表，如下示例（省略了部分列）

示例1

```
$ netstat -nrv
Kernel IP routing table
Destination     Gateway         Genmask         Iface
0.0.0.0         81.187.150.214  0.0.0.0
10.92.213.0     10.92.213.242   255.255.255.0   eth0
81.187.150.208  81.187.150.216  255.255.255.240 eth1
127.0.0.1       127.0.0.1       255.255.255.255 lo
```

> 上表中共出现了3台路由器。访问私有网络`10.92.213.0/24`中的设备时需要通过`eth0`访问。当前配置访问`10.92.213.0/24`以外的网络时通过路由器`81.187.150.214`，而该路由器位于`eth1`连接的网络`81.187.150.208/28`内。此时如果`10.92.213.0/24`内的路由器`10.92.213.242`可以访问其他网络，我们也可以将第一行路由器地址更改为`10.92.213.242`

示例2

```
$ netstat -nrv
Kernel IP routing table
Destination     Gateway         Genmask         Iface
0.0.0.0         172.22.0.1      0.0.0.0         eth0
172.22.0.0      0.0.0.0         255.255.0.0     eth0
```

> 上表表明主机通过`eth0`连接了一个私有网络（如果可以访问上一层网络，就是NAT网络）。访问`172.22.0.0/16`局域网内的设备时无需通过网关，直接ARP后发送数据包即可

路由器中的路由表结构和上述类似，区别是可能会有其他的一些相关信息。**动态路由**通过学习获得，而**静态路由**由人工配置

通常路由器的路由表都会包含有**目的网络地址**，**网络掩码**，**Metric**（路径长度），**Next hop**（下一跳路由器地址）。路由器会自动选择Metric最短的路径

路由表还会包含其他信息，如**Interface**（上例的`eth0`），**QoS Flags**（例如`U`表示路由有效，`G`表示该路由表项指向一个网关，`S`表示是通过`route`命令配置的静态路由表项），以及安全配置（常见于防火墙）等

在现代路由器中，路由表需要转换为更高效的Forwarding table才能应用

### 4.3.2 路由协议

常见的路由协议有`RIP`，`RIPv2`，`OSPF`，`IS-IS`等，路由器之间需要使用路由协议来**交换路由信息**。公网中的路由器都依赖路由协议来寻找路径

**RIP**

`RIPv2`协议于1994年发布，作为`RIPv1`的继任者，定义于RFC2453，更新于RFC4822。`RIP`（RFC1058）是应用层协议，走`UDP`，端口`520`。`RIP`的数据交换只发生在邻近路由器之间，是一种**距离矢量**类型的协议

`RIP`使用hops（跳转）作为metrics对路径长短进行评估，并包含在路由表中。路由器**每隔一段时间**（通常30秒，可能加上随机的正负offset）就会向邻近的路由器（adjacent）广播它的路由信息，邻近的路由器根据这些信息更新自己的路由信息。更新时会对metrics进行**累加操作**，如果发现同一目标IP对应的metrics变小了**说明有更优的路径**，路由器会使用对应的metrics以及网关地址替代原有的路由表项；如果发现**同一个相邻网关**发来的metrics变大了，那么就会将这个更大的metrics替换原来的metrics；此外每一个路由表项还有一个超时计时器，超过指定时间（180秒）未收到原有网关发来的更新，就认为已经失效，失效后再经过一段超时，此项就会被删除（后两种操作是面向网络故障而提出的应对方法，metrics既可以增也可以减）

> 路由表项的删除可能由超时或路由更新导致。旧的路由表项删除倒计时120秒，同时它的`metric`会被设为`16`，flag会对应表示该项已更改。之后会触发该路由器发送一次更新数据包
>
> `RIPv2`使用了`224.0.0.9`组播地址而不是`RIPv1`的`255.255.255.255`广播。此外`RIPv2`在路由信息中**包含了网络掩码**以支持`CIDR`，其路由表基于网络地址构建（也可以包含节点地址。`RIPv1`通常对每一个节点IP或网络建立一个路由表项，一个IP地址到来时选择其中最符合的），以及附加的Authentication
>
> `RIP`系列协议为限制收敛时间，最多支持15个跳转，这意味着它不能用于距离相隔过远的网络。`RIP`的设计也导致网络故障时容易产生路由数据泛滥，收敛（稳定）速度慢，且容易产生振荡
>
> `RIP`同时也提出了`Split Horizon`以及`Triggered updates`，在网络出现故障时有助于路由信息的收敛

`RIPv2`分享路由数据的格式如下。`command`为`1`表示路由信息请求（例如新路由器上线），`2`表示回复。`version`表示`RIP`版本，为`2`。`AFI`为`2`表示IPv4，`Next Hop`为下一跳网关地址（对接收方来说是向后2个网关的地址）。一个包可以包含`1`到`25`个入口，每个长`20`字节。`metric`有效值最大只能取`15`，`16`表示infinity

```
Header

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  command (1)  |  version (1)  |       must be zero (2)        |
   +---------------+---------------+-------------------------------+
   |                                                               |
   ~                         RIP Entry (20)                        ~
   |                                                               |
   +---------------+---------------+---------------+---------------+

Entry

    0                   1                   2                   3 3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   | Address Family Identifier (2) |        Route Tag (2)          |
   +-------------------------------+-------------------------------+
   |                         IP Address (4)                        |
   +---------------------------------------------------------------+
   |                         Subnet Mask (4)                       |
   +---------------------------------------------------------------+
   |                         Next Hop (4)                          |
   +---------------------------------------------------------------+
   |                         Metric (4)                            |
   +---------------------------------------------------------------+
```

**OSPF**

`OSPF`是一种**链路状态**类型的协议，全称`Open Shortest Path First`，同时支持IPv4和IPv6，支持`CIDR`，最初于1998年为IPv4设计（RFC2328），主要基于Dijikstra算法。由于`OSPF`~~可以单独写一篇长文章~~，这里不再讲解，有兴趣可以看相关文档

## 4.4 ARP协议

参考RFC826

`ARP`协议运行于IPv4同一层级，在IPv4 Ethernet网络中可以让一台设备获取IP对应的设备MAC地址。`ARP`数据包的`EtherType`为`0x0806`

`ARP`除了可以获取MAC地址以外，还可以用于检测网络内的IP地址冲突

`ARP`中**请求方**和**发送回复的被请求方**使用相同的数据包格式。设计最初还是考虑了其他协议的，除去以太网包装后`ARP`数据包的格式如下

| 名称 | 长度（Byte） | 注解 |
| :-: | :-: | :-: |
| `HTYPE` | `2` | 数据链路层协议，`1`代表`Ethernet` |
| `PTYPE` | `2` | 网络层协议，`0x0800`代表`IPv4`，定义和`EtherType`相同 |
| `HLEN` | `1` | 链路层协议地址（物理地址）长度（单位Byte）。`Ethernet`（MAC）地址长`6` |
| `PLEN` | `1` | 网络层协议地址长度（单位Byte）。`IPv4`地址长`4` |
| `OPER` | `2` | 操作类型，`1`表示Request，`2`表示Reply |
| `SHA` | `HLEN` | 发送方的物理地址（MAC地址） |
| `SPA` | `PLEN` | 发送方的网络地址（IPv4地址） |
| `THA` | `HLEN` | 目标的物理地址 |
| `TPA` | `PLEN` | 目标的网络地址 |

> 在IPv4网络中，每一台主机的内存里都会缓存有一张`ARP`表，用于记录IP地址和以台网MAC地址的对应关系。每次主机想要将数据发往**本地网络**的一个指定节点（包括默认网关），它就会在表中查询这个IP对应的MAC。查询到以后就会直接将这个数据包发往对应的目的MAC
>
> 如果没有查询到，主机会将以太网目的地址设置为广播地址`FF:FF:FF:FF:FF:FF`，这样本地网络（通过交换机互联）的所有设备都会接收到这个`ARP`数据包。发送时`ARP`数据包类型`OPER`为`1`请求，`SHA`为主机MAC，`SPA`为主机IP，`THA`全`FF`，`TPA`为目标主机的IP
>
> 本地网络中的其他主机接收到数据包以后，会依次检查`HTYPE` `PTYPE`，以及`TPA`。如果`TPA`符合，主机会将`SHA` `SPA`存入自己的`ARP`表中。如果确定`OPER`为`1`，那么主机会进行回应，发送一个`OPER`为`2`的数据包，同时将收发地址交换，将以太网数据包的目的MAC以及`SHA`更换为本机的MAC，送往原先的请求方

> `ARP`的实现较为简单，缺点是非常不安全，容易劫持

## 4.5 NDP协议

参考RFC4861

`NDP`协议用于IPv6网络，运行于IPv6更高一层级，包含了类似`ARP`的地址解析功能，但是走`ICMPv6`。`ICMPv6`通过IPv6数据包搭载，`Next Header`值为`58`

`NDP`定义了如下几个`ICMPv6`数据包。Solicitate就是Query的意思

| 名称 | ICMPv6 Type | 作用 |
| :-: | :-: | :-: |
| `RS` Router Solicitation | `133` | 主机请求本地网络中路由器信息 |
| `RA` Router Advertisement | `134` | 路由器在收到`RS`后，或每隔一段时间广播自己，表明存在，附带一些其他参数信息例如网络MTU |
| `NS` Neighbor Solicitation | `135` | 邻居请求，用于请求指定IPv6主机的MAC地址或验证其在线 |
| `NA` Neighbor Advertisement | `136` | 邻居广播，用于回复`NS`报文等用途 |
| `Redirect` | `137` | 重定向，路由器通知主机可以连接到另一个路由器，速度更快 |

> 以上报文通常需要搭配[多播IPv6](#424-ipv6多播地址)使用，`ff02::1`网络内所有节点，`ff02::2`网络内所有路由
>
> 除了MAC地址获取以及IP冲突检测外，`NDP`还可以寻找网络内路由，获取网络MTU、hop limit参数，地址分配获取（`SLAAC`，之后会讲解），重定向，可用性检测（reachability）功能等

`NDP`协议主要使用`NS`和`NA`报文来进行MAC地址的请求，地址冲突检测和可用性检测

`NS`和`NA`数据包格式分别如下

```
Neighbor Solicitation

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |     Code      |          Checksum             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                           Reserved                            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                       Target Address                          +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   Options ...
   +-+-+-+-+-+-+-+-+-+-+-+-

Neighbor Advertisement

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |     Code      |          Checksum             |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |R|S|O|                     Reserved                            |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                                                               |
   +                                                               +
   |                                                               |
   +                       Target Address                          +
   |                                                               |
   +                                                               +
   |                                                               |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   Options ...
   +-+-+-+-+-+-+-+-+-+-+-+-

Options (MAC)

    0                   1                   2                   3
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Type      |    Length     |    Link-Layer Address ...
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

> `NS`报文的IPv6头中源地址通常为本机IP地址或`0:0:0:0:0:0:0:0`（如未分配地址），目的地址为多播/组播地址（如`ff02:1`）或直接就是目的IP地址（例如在检测对方可用性时）。而`NS`报文包含的目的地址是表示请求的IP地址，不能是多播地址或无效地址。`Code`为`0`。在多播报文中必须在`Options`包含发送方（本机）的MAC地址
>
> `NA`报文的IPv6头中源地址是本机IP地址，目的地址为原先请求方的IP地址或多播/组播地址（如请求方未分配地址）。`R`表示发送方是一台路由器，`S`表示是应请求发送的回复报文，而不是自主发送的报文（此时目标IP必须非多播，在可用性检测中有用），`O`表示覆盖原有的MAC地址缓存。通常`NA`回复报文包含的目的地址和原先对应的`NS`报文相同。`Code`为`0`。`Options`为本机的MAC地址，在多播报文中同样需要包含
>
> `Options`中`Type`为`1`表示源MAC（`NS`报文常用），为`2`表示目标MAC（`NA`报文常用）

> 主机请求指定IP的MAC地址时，主机首先需要发送一个组播ICMPv6 `NS`报文，这个`NS`报文使用组播目标MAC，IPv6头的源地址为本机IP，目标地址为被请求方的**组播IP地址**`ff02::1:ffXX:XXXX`。`NS`报文body的目标地址为被请求方的**单播IP地址**。并且在`NS`报文最后附上本机的MAC，`Type`为`1`
>
> 被请求方回复MAC地址请求时，发送一个`NA`报文，这个报文的源MAC和目标MAC分别为被请求方MAC以及请求方的MAC（非组播），源IP和目标IP同理。`NA`报文body的目标地址依然是自己的**单播IP地址**。在`NA`最后附上自己的MAC地址，`Type`为`2`

## 4.6 NAT

参考RFC1918

NAT全称`Network Address Translation`，由路由器实现，它可以使得私有网络内的多台主机共用一个公网IP地址，本质上是利用传输层的端口号（长16位）来弥补IPv4不足的问题。IPv4网络下我们日常用的局域网都使用了私有IP地址。同时NAT在某种程度上为IPv4网络提供了天生的安全保护，私有网络内的主机端口不会暴露在公网下（除非刻意进行配置），有效阻挡来自外界的不良请求。但是NAT打破了一些原有的规则，增加了复杂度

NAT网络需要路由器理解传输层。家用路由都是NAT路由器

在NAT网络中，访问当前私有网络以外网络的数据包会被直接发送往NAT路由。假设当前NAT路由的WAN口直接连接了公网并拥有公网IP（假设`194.47.156.230`）。我们访问一台公网主机产生一个数据包。那么在私有网络内，该数据包：

> 源IP为主机在私有网络内的IP（假设`192.168.1.23`），目标IP为被访问公网主机的IP（假设为`17.253.144.10`）（MAC的修改省略）
>
> 源Port为主机发送数据的传输层Port，目标Port为公网主机提供服务的Port（假设访问`http`，端口`80`，源端口`10320`）

NAT路由接收到上述数据包以后，进行以下操作后发送：

> 记录两个IP和端口（`192.168.1.23:10320, 17.253.144.10:80`）。将源IP修改为WAN口IP，再随机分配一个未使用过的上行端口（例如`12004`）。发送的数据包的源IP和Port变为`194.47.156.230:12004`，最终形成`192.168.1.23:10320 -> WAN Port 12004 -> 17.253.144.10:80`的映射

公网主机收到后回复一个数据包，路由器进行以下操作：

> 发现WAN端口`12004`收到了来自`17.253.144.10:80`的数据包。经过查表将目标IP和Port改为`192.168.1.23:10320`，发送给私有网络内的主机

实际上NAT的应用场景不限于以上示例。Outbound NAT时，数据从私有网络发送往上层网络，不同的内网`host:port`访问相同的外网`host:port`，必须分配不同的WAN端口（如果访问不同外网`host:port`，可以分配相同WAN端口，但是没必要这么做。而相同内网`host:port`访问不同外网`host:port`，也可以分配相同的WAN端口）。Inbound NAT时，NAT路由直接查询之前的表格就可以确定内网的`host:port`


## 5 传输层

传输层协议以TCP、UDP为主导，ICMP用于网络控制管理等特殊功能。其他大部分传输层协议都是基于TCP或UDP设计而来的

## 5.1 TCP

## 5.2 UDP

## 5.3 ICMP和ICMPv6

## 5.4 QUIC

## 5.5 TLS

## 6 应用层

## 6.1 HTTP

## 6.2 HTTPS

## 6.3 DNS

## 6.4 DHCP和DHCPv6

### 6.4.1 SLAAC

## 6.5 Telnet

## 6.6 FTP

## 6.7 SMTP

## 6.8 SNMP